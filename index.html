// Add to the existing VolleyballApp component after the PWA state variables

// Substitutional mode state
const [gameMode, setGameMode] = useState(() => loadFromStorage('volleyball_gameMode', 'rotational'));
const [substitutionPairs, setSubstitutionPairs] = useState(() => loadFromStorage('volleyball_substitutionPairs', []));
const [substitutionCount, setSubstitutionCount] = useState(0);
const [currentRotation, setCurrentRotation] = useState(0);

// Color palette for substitution pairs
const pairColors = [
    { bg: 'bg-red-100', border: 'border-red-500', name: 'red' },
    { bg: 'bg-blue-100', border: 'border-blue-500', name: 'blue' },
    { bg: 'bg-green-100', border: 'border-green-500', name: 'green' },
    { bg: 'bg-purple-100', border: 'border-purple-500', name: 'purple' },
    { bg: 'bg-pink-100', border: 'border-pink-500', name: 'pink' },
    { bg: 'bg-indigo-100', border: 'border-indigo-500', name: 'indigo' }
];

// Updated player initialization with new ratings
const [players, setPlayers] = useState(() => loadFromStorage('volleyball_players', [
    { id: 1, name: '1', defense: 3, serving: 3, serveReceive: 3, setting: 3, allAround: 3, active: true, star: false },
    { id: 2, name: '2', defense: 3, serving: 3, serveReceive: 3, setting: 3, allAround: 3, active: true, star: false },
    { id: 3, name: '3', defense: 3, serving: 3, serveReceive: 3, setting: 3, allAround: 3, active: true, star: false },
    { id: 4, name: '4', defense: 3, serving: 3, serveReceive: 3, setting: 3, allAround: 3, active: true, star: false },
    { id: 5, name: '5', defense: 3, serving: 3, serveReceive: 3, setting: 3, allAround: 3, active: true, star: false },
    { id: 6, name: '6', defense: 3, serving: 3, serveReceive: 3, setting: 3, allAround: 3, active: true, star: false },
    { id: 7, name: '7', defense: 3, serving: 3, serveReceive: 3, setting: 3, allAround: 3, active: true, star: false },
    { id: 8, name: '8', defense: 3, serving: 3, serveReceive: 3, setting: 3, allAround: 3, active: true, star: false },
    { id: 9, name: '9', defense: 3, serving: 3, serveReceive: 3, setting: 3, allAround: 3, active: true, star: false },
    { id: 10, name: '10', defense: 3, serving: 3, serveReceive: 3, setting: 3, allAround: 3, active: true, star: false }
]));

// Updated player form to include new ratings
const [playerForm, setPlayerForm] = useState({
    name: '',
    defense: 3,
    serving: 3,
    serveReceive: 3,
    setting: 3,
    allAround: 3,
    active: true,
    star: false
});

// Save substitutional mode data to localStorage
useEffect(() => {
    saveToStorage('volleyball_gameMode', gameMode);
}, [gameMode]);

useEffect(() => {
    saveToStorage('volleyball_substitutionPairs', substitutionPairs);
}, [substitutionPairs]);

// Helper function to get player's pair color
const getPlayerPairColor = (playerId) => {
    if (gameMode !== 'substitutional') return null;
    
    const pair = substitutionPairs.find(pair => 
        pair.player1.id === playerId || pair.player2.id === playerId
    );
    
    if (pair) {
        return pairColors[pair.colorIndex] || pairColors[0];
    }
    
    // Check if player is designated as no-sub (gold)
    const player = players.find(p => p.id === playerId);
    if (player && player.noSub) {
        return { bg: 'bg-yellow-100', border: 'border-yellow-500', name: 'gold' };
    }
    
    return { bg: 'bg-gray-100', border: 'border-gray-300', name: 'unpaired' };
};

// Function to toggle game mode
const toggleGameMode = () => {
    const newMode = gameMode === 'rotational' ? 'substitutional' : 'rotational';
    setGameMode(newMode);
    
    // Reset substitution-specific state when switching modes
    if (newMode === 'rotational') {
        setSubstitutionPairs([]);
        setSubstitutionCount(0);
        setCurrentRotation(0);
    }
};

// Function to find optimal substitution pairs
const optimizeSubstitutionPairs = () => {
    const activePlayers = players.filter(p => p.active);
    
    if (activePlayers.length < 6) {
        alert("Need at least 6 active players for substitutional mode.");
        return;
    }
    
    // Determine how many players should not have subs
    const totalPlayers = activePlayers.length;
    const playersWithoutSubs = totalPlayers % 2; // 0 if even, 1 if odd
    
    // Sort players by overall rating for determining no-sub candidates
    const sortedByOverall = [...activePlayers].sort((a, b) => {
        const aOverall = (a.defense + a.serving + a.serveReceive + a.setting + a.allAround) / 5;
        const bOverall = (b.defense + b.serving + b.serveReceive + b.setting + b.allAround) / 5;
        return bOverall - aOverall;
    });
    
    // Mark top players as no-sub if needed
    const noSubPlayers = sortedByOverall.slice(0, playersWithoutSubs);
    const pairablePlayers = sortedByOverall.slice(playersWithoutSubs);
    
    // Update players with noSub designation
    setPlayers(prevPlayers => 
        prevPlayers.map(p => ({
            ...p,
            noSub: noSubPlayers.some(noSub => noSub.id === p.id)
        }))
    );
    
    // Generate optimal pairs
    const pairs = generateOptimalPairs(pairablePlayers);
    setSubstitutionPairs(pairs);
};

// Algorithm to generate optimal substitution pairs
const generateOptimalPairs = (players) => {
    const pairs = [];
    const usedPlayers = new Set();
    
    // Simple greedy pairing algorithm
    // In a more sophisticated version, this would use combinatorial optimization
    for (let i = 0; i < players.length; i++) {
        if (usedPlayers.has(players[i].id)) continue;
        
        let bestPartner = null;
        let bestScore = -1;
        
        for (let j = i + 1; j < players.length; j++) {
            if (usedPlayers.has(players[j].id)) continue;
            
            // Calculate pairing score based on complementary skills
            const player1 = players[i];
            const player2 = players[j];
            
            // Score based on how well they complement each other
            const frontRowScore = Math.max(player1.setting, player2.setting);
            const backRowScore = Math.max(player1.serveReceive, player2.serveReceive);
            const overallScore = (player1.allAround + player2.allAround) / 2;
            
            const pairScore = frontRowScore + backRowScore + overallScore;
            
            if (pairScore > bestScore) {
                bestScore = pairScore;
                bestPartner = player2;
            }
        }
        
        if (bestPartner) {
            pairs.push({
                player1: players[i],
                player2: bestPartner,
                colorIndex: pairs.length % pairColors.length,
                score: bestScore
            });
            
            usedPlayers.add(players[i].id);
            usedPlayers.add(bestPartner.id);
        }
    }
    
    return pairs;
};

// Function to manually reassign pair colors
const reassignPairColor = (pairIndex, newColorIndex) => {
    setSubstitutionPairs(prev => 
        prev.map((pair, index) => 
            index === pairIndex 
                ? { ...pair, colorIndex: newColorIndex }
                : pair
        )
    );
};

// Updated handleAddPlayer for new ratings
const handleAddPlayer = () => {
    if (playerForm.name.trim()) {
        const newPlayer = {
            id: Date.now(),
            ...playerForm
        };
        setPlayers([...players, newPlayer]);
        setPlayerForm({ 
            name: '', 
            defense: 3, 
            serving: 3, 
            serveReceive: 3, 
            setting: 3, 
            allAround: 3, 
            active: true, 
            star: false 
        });
        setShowPlayerForm(false);
    }
};

// Updated handleUpdatePlayer for new ratings
const handleUpdatePlayer = () => {
    setPlayers(players.map(p => 
        p.id === editingPlayer ? { ...playerForm, id: editingPlayer } : p
    ));
    setEditingPlayer(null);
    setPlayerForm({ 
        name: '', 
        defense: 3, 
        serving: 3, 
        serveReceive: 3, 
        setting: 3, 
        allAround: 3, 
        active: true, 
        star: false 
    });
    setShowPlayerForm(false);
};
// Updated PlayerTile component with color coding for substitutional mode
const PlayerTile = ({ player, position, isOnCourt, benchIndex, onDragStart }) => {
    const pairColor = getPlayerPairColor(player.id);
    
    return React.createElement('div', {
        className: `p-3 rounded-lg shadow-md cursor-pointer transition-all ${
            player.active 
                ? (isOnCourt ? `${pairColor?.bg || 'bg-blue-100'} border-2 ${pairColor?.border || 'border-blue-500'}` 
                             : `${pairColor?.bg || 'bg-green-100'} border-2 ${pairColor?.border || 'border-green-400'}`)
                : 'bg-gray-200 border-2 border-gray-300'
        } ${player.star ? 'star-player' : ''} ${draggedPlayer && draggedPlayer.id === player.id ? 'dragging' : ''}`,
        draggable: true,
        onMouseDown: (e) => {
            if (e.button === 0) { // Left mouse button
                onDragStart && onDragStart(e, player);
            }
        },
        onTouchStart: (e) => {
            onDragStart && onDragStart(e, player);
        },
        onClick: gameMode === 'rotational' ? () => handleEditPlayer(player) : undefined
    },
        React.createElement('div', { className: "flex items-center justify-between" },
            React.createElement('div', { className: "font-semibold text-sm" }, player.name),
            React.createElement('div', { className: "flex items-center gap-1" },
                player.star && React.createElement('span', { className: "text-yellow-500 text-xs" }, 'â­'),
                gameMode === 'substitutional' && player.noSub && React.createElement('span', { className: "text-yellow-600 text-xs font-bold" }, 'NS')
            )
        ),
        position && React.createElement('div', { className: "text-xs text-gray-600 mt-1" }, position),
        gameMode === 'substitutional' && pairColor && (
            React.createElement('div', { className: "text-xs mt-1 font-medium" }, 
                pairColor.name === 'gold' ? 'No Sub' : `Pair: ${pairColor.name}`
            )
        )
    );
};

// Enhanced Player Form Modal with new ratings
const EnhancedPlayerForm = () => (
    showPlayerForm && React.createElement('div', { className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" },
        React.createElement('div', { className: "bg-white rounded-lg p-6 w-80 mx-4 max-h-96 overflow-y-auto" },
            React.createElement('h3', { className: "text-lg font-semibold mb-4" },
                editingPlayer ? 'Edit Player' : 'Add New Player'
            ),
            
            React.createElement('div', { className: "space-y-4" },
                React.createElement('div', {},
                    React.createElement('label', { className: "block text-sm font-medium mb-1" }, "Player Name"),
                    React.createElement('input', {
                        type: "text",
                        value: playerForm.name,
                        onChange: (e) => setPlayerForm({...playerForm, name: e.target.value}),
                        className: "w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none",
                        placeholder: "Enter player name"
                    })
                ),
                
                React.createElement('div', {},
                    React.createElement('label', { className: "block text-sm font-medium mb-1" }, "Defense (1-5)"),
                    React.createElement('input', {
                        type: "range",
                        min: "1",
                        max: "5",
                        value: playerForm.defense,
                        onChange: (e) => setPlayerForm({...playerForm, defense: parseInt(e.target.value)}),
                        className: "w-full"
                    }),
                    React.createElement('div', { className: "text-center font-semibold text-sm" }, playerForm.defense)
                ),
                
                React.createElement('div', {},
                    React.createElement('label', { className: "block text-sm font-medium mb-1" }, "Serving (1-5)"),
                    React.createElement('input', {
                        type: "range",
                        min: "1",
                        max: "5",
                        value: playerForm.serving,
                        onChange: (e) => setPlayerForm({...playerForm, serving: parseInt(e.target.value)}),
                        className: "w-full"
                    }),
                    React.createElement('div', { className: "text-center font-semibold text-sm" }, playerForm.serving)
                ),

                React.createElement('div', {},
                    React.createElement('label', { className: "block text-sm font-medium mb-1" }, "Serve Receive (1-5)"),
                    React.createElement('input', {
                        type: "range",
                        min: "1",
                        max: "5",
                        value: playerForm.serveReceive,
                        onChange: (e) => setPlayerForm({...playerForm, serveReceive: parseInt(e.target.value)}),
                        className: "w-full"
                    }),
                    React.createElement('div', { className: "text-center font-semibold text-sm" }, playerForm.serveReceive)
                ),

                React.createElement('div', {},
                    React.createElement('label', { className: "block text-sm font-medium mb-1" }, "Setting (1-5)"),
                    React.createElement('input', {
                        type: "range",
                        min: "1",
                        max: "5",
                        value: playerForm.setting,
                        onChange: (e) => setPlayerForm({...playerForm, setting: parseInt(e.target.value)}),
                        className: "w-full"
                    }),
                    React.createElement('div', { className: "text-center font-semibold text-sm" }, playerForm.setting)
                ),

                React.createElement('div', {},
                    React.createElement('label', { className: "block text-sm font-medium mb-1" }, "All Around (1-5)"),
                    React.createElement('input', {
                        type: "range",
                        min: "1",
                        max: "5",
                        value: playerForm.allAround,
                        onChange: (e) => setPlayerForm({...playerForm, allAround: parseInt(e.target.value)}),
                        className: "w-full"
                    }),
                    React.createElement('div', { className: "text-center font-semibold text-sm" }, playerForm.allAround)
                ),

                React.createElement('div', { className: "flex items-center gap-2" },
                    React.createElement('label', { className: "block text-sm font-medium" }, "Star Player"),
                    React.createElement('button', {
                        onClick: () => setPlayerForm({...playerForm, star: !playerForm.star}),
                        className: `w-6 h-6 rounded-full border-2 flex items-center justify-center ${
                            playerForm.star ? 'bg-yellow-400 border-yellow-500' : 'border-gray-300 hover:border-yellow-400'
                        }`,
                        type: "button"
                    },
                        React.createElement('span', { className: "text-xs" }, playerForm.star ? 'â­' : 'â˜†')
                    )
                )
            ),
            
            React.createElement('div', { className: "flex gap-3 mt-6" },
                React.createElement('button', {
                    onClick: () => {
                        setShowPlayerForm(false);
                        setEditingPlayer(null);
                        setPlayerForm({ 
                            name: '', 
                            defense: 3, 
                            serving: 3, 
                            serveReceive: 3, 
                            setting: 3, 
                            allAround: 3, 
                            active: true, 
                            star: false 
                        });
                    },
                    className: "flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                }, "Cancel"),
                React.createElement('button', {
                    onClick: editingPlayer ? handleUpdatePlayer : handleAddPlayer,
                    className: "flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600",
                    disabled: !playerForm.name.trim()
                }, editingPlayer ? 'Update Player' : 'Add Player')
            )
        )
    )
);

// Game Mode Toggle Component
const GameModeToggle = () => (
    React.createElement('div', { className: "mb-4 p-4 bg-gray-50 border border-gray-200 rounded-lg" },
        React.createElement('div', { className: "flex items-center justify-between mb-3" },
            React.createElement('h3', { className: "text-lg font-semibold" }, "Game Mode"),
            React.createElement('button', {
                onClick: toggleGameMode,
                className: `px-4 py-2 rounded-lg font-medium transition-colors ${
                    gameMode === 'rotational' 
                        ? 'bg-blue-500 text-white hover:bg-blue-600' 
                        : 'bg-purple-500 text-white hover:bg-purple-600'
                }`
            },
                gameMode === 'rotational' ? 'Switch to Substitutional' : 'Switch to Rotational'
            )
        ),
        React.createElement('div', { className: "text-sm text-gray-600" },
            gameMode === 'rotational' 
                ? "Current: Rotational play - optimizes player rotation order" 
                : "Current: Substitutional play - optimizes player pairing for substitutions"
        ),
        gameMode === 'substitutional' && React.createElement('div', { className: "mt-3 flex gap-2" },
            React.createElement('button', {
                onClick: optimizeSubstitutionPairs,
                className: "px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm",
                disabled: players.filter(p => p.active).length < 6
            }, "Optimize Pairs"),
            substitutionPairs.length > 0 && React.createElement('div', { className: "flex items-center text-sm text-gray-600" },
                `${substitutionPairs.length} pairs created, ${substitutionCount} subs used`
            )
        )
    )
);

// Substitution Pairs Display Component
const SubstitutionPairsDisplay = () => (
    gameMode === 'substitutional' && substitutionPairs.length > 0 && 
    React.createElement('div', { className: "mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg" },
        React.createElement('h4', { className: "text-md font-semibold mb-3" }, "Substitution Pairs"),
        React.createElement('div', { className: "grid grid-cols-1 gap-2" },
            substitutionPairs.map((pair, index) => {
                const color = pairColors[pair.colorIndex];
                return React.createElement('div', { 
                    key: index, 
                    className: `p-2 ${color.bg} ${color.border} border rounded-lg flex items-center justify-between`
                },
                    React.createElement('div', { className: "text-sm font-medium" },
                        `${pair.player1.name} â†” ${pair.player2.name}`
                    ),
                    React.createElement('select', {
                        value: pair.colorIndex,
                        onChange: (e) => reassignPairColor(index, parseInt(e.target.value)),
                        className: "text-xs p-1 border rounded"
                    },
                        pairColors.map((color, colorIndex) => 
                            React.createElement('option', { key: colorIndex, value: colorIndex }, color.name)
                        )
                    )
                );
            })
        )
    )
);
// Substitutional rotation logic and auto-substitution management

// Function to determine optimal player for a position based on substitutional rules
const getOptimalPlayerForPosition = (position, availablePlayers, currentRotation) => {
    const frontRowPositions = ['frontLeft', 'frontMiddle', 'frontRight'];
    const backRowPositions = ['backLeft', 'backMiddle', 'backRight'];
    
    if (frontRowPositions.includes(position)) {
        // Prioritize setting ability for front row
        return availablePlayers.sort((a, b) => b.setting - a.setting)[0];
    } else if (backRowPositions.includes(position)) {
        // Prioritize serve receive for back row
        return availablePlayers.sort((a, b) => b.serveReceive - a.serveReceive)[0];
    }
    
    // Fallback to all-around ability
    return availablePlayers.sort((a, b) => b.allAround - a.allAround)[0];
};

// Function to get available players for a position (considering pairs)
const getAvailablePlayersForPosition = (position, currentCourtPlayers, substitutionPairs) => {
    const frontRowPositions = ['frontLeft', 'frontMiddle', 'frontRight'];
    const backRowPositions = ['backLeft', 'backMiddle', 'backRight'];
    const isTargetFrontRow = frontRowPositions.includes(position);
    
    // Get all active players
    const activePlayers = players.filter(p => p.active);
    
    // Find players who can be substituted into this position
    const availablePlayers = [];
    
    activePlayers.forEach(player => {
        // Check if player is already on court
        const isOnCourt = Object.values(currentCourtPlayers).some(courtPlayer => 
            courtPlayer && courtPlayer.id === player.id
        );
        
        if (isOnCourt) return;
        
        // Check if player has a substitute pair
        const playerPair = substitutionPairs.find(pair => 
            pair.player1.id === player.id || pair.player2.id === player.id
        );
        
        if (playerPair) {
            // Check if their pair partner is currently on court
            const partner = playerPair.player1.id === player.id ? playerPair.player2 : playerPair.player1;
            const partnerOnCourt = Object.values(currentCourtPlayers).some(courtPlayer => 
                courtPlayer && courtPlayer.id === partner.id
            );
            
            if (partnerOnCourt) {
                availablePlayers.push(player);
            }
        } else if (player.noSub) {
            // Players without subs are always available if not on court
            availablePlayers.push(player);
        }
    });
    
    return availablePlayers;
};

// Enhanced rotation function for substitutional mode
const rotateForwardSubstitutional = () => {
    if (gameMode !== 'substitutional') {
        rotateForward();
        return;
    }
    
    const currentCourtPlayers = {
        backLeft: courtPositions.backLeft,
        frontLeft: courtPositions.frontLeft,
        frontMiddle: courtPositions.frontMiddle,
        frontRight: courtPositions.frontRight,
        backRight: courtPositions.backRight,
        backMiddle: courtPositions.backMiddle
    };
    
    // Rotate positions
    const rotatedPositions = {
        backRight: currentCourtPlayers.backMiddle,
        frontRight: currentCourtPlayers.backRight,
        frontMiddle: currentCourtPlayers.frontRight,
        frontLeft: currentCourtPlayers.frontMiddle,
        backLeft: currentCourtPlayers.frontLeft,
        backMiddle: currentCourtPlayers.backLeft
    };
    
    // Optimize substitutions for new positions
    const optimizedPositions = optimizeSubstitutionsForRotation(rotatedPositions);
    
    setCourtPositions({
        ...optimizedPositions,
        bench: courtPositions.bench
    });
    
    setCurrentRotation(prev => (prev + 1) % 6);
    updateSubstitutionCount(optimizedPositions, currentCourtPlayers);
};

// Enhanced rotation function for substitutional mode (backward)
const rotateBackwardSubstitutional = () => {
    if (gameMode !== 'substitutional') {
        rotateBackward();
        return;
    }
    
    const currentCourtPlayers = {
        backLeft: courtPositions.backLeft,
        frontLeft: courtPositions.frontLeft,
        frontMiddle: courtPositions.frontMiddle,
        frontRight: courtPositions.frontRight,
        backRight: courtPositions.backRight,
        backMiddle: courtPositions.backMiddle
    };
    
    // Rotate positions backward
    const rotatedPositions = {
        frontLeft: currentCourtPlayers.backLeft,
        frontMiddle: currentCourtPlayers.frontLeft,
        frontRight: currentCourtPlayers.frontMiddle,
        backRight: currentCourtPlayers.frontRight,
        backMiddle: currentCourtPlayers.backRight,
        backLeft: currentCourtPlayers.backMiddle
    };
    
    // Optimize substitutions for new positions
    const optimizedPositions = optimizeSubstitutionsForRotation(rotatedPositions);
    
    setCourtPositions({
        ...optimizedPositions,
        bench: courtPositions.bench
    });
    
    setCurrentRotation(prev => (prev - 1 + 6) % 6);
    updateSubstitutionCount(optimizedPositions, currentCourtPlayers);
};

// Function to optimize substitutions for a given rotation
const optimizeSubstitutionsForRotation = (rotatedPositions) => {
    const optimizedPositions = { ...rotatedPositions };
    
    Object.keys(optimizedPositions).forEach(position => {
        const currentPlayer = optimizedPositions[position];
        if (!currentPlayer) return;
        
        const availablePlayers = getAvailablePlayersForPosition(position, optimizedPositions, substitutionPairs);
        const optimalPlayer = getOptimalPlayerForPosition(position, availablePlayers, currentRotation);
        
        if (optimalPlayer && optimalPlayer.id !== currentPlayer.id) {
            // Check if substitution would improve position rating
            const frontRowPositions = ['frontLeft', 'frontMiddle', 'frontRight'];
            const backRowPositions = ['backLeft', 'backMiddle', 'backRight'];
            
            let currentRating, optimalRating;
            
            if (frontRowPositions.includes(position)) {
                currentRating = currentPlayer.setting;
                optimalRating = optimalPlayer.setting;
            } else if (backRowPositions.includes(position)) {
                currentRating = currentPlayer.serveReceive;
                optimalRating = optimalPlayer.serveReceive;
            } else {
                currentRating = currentPlayer.allAround;
                optimalRating = optimalPlayer.allAround;
            }
            
            // Only substitute if it improves the rating
            if (optimalRating > currentRating) {
                optimizedPositions[position] = optimalPlayer;
            }
        }
    });
    
    return optimizedPositions;
};

// Function to update substitution count
const updateSubstitutionCount = (newPositions, oldPositions) => {
    let subsUsed = 0;
    
    Object.keys(newPositions).forEach(position => {
        const oldPlayer = oldPositions[position];
        const newPlayer = newPositions[position];
        
        if (oldPlayer && newPlayer && oldPlayer.id !== newPlayer.id) {
            subsUsed++;
        }
    });
    
    setSubstitutionCount(prev => prev + subsUsed);
};

// Function to manually create substitution pair
const createManualPair = (player1Id, player2Id) => {
    const player1 = players.find(p => p.id === player1Id);
    const player2 = players.find(p => p.id === player2Id);
    
    if (!player1 || !player2) return;
    
    // Remove any existing pairs involving these players
    const updatedPairs = substitutionPairs.filter(pair => 
        pair.player1.id !== player1Id && pair.player2.id !== player1Id &&
        pair.player1.id !== player2Id && pair.player2.id !== player2Id
    );
    
    // Add new pair
    const newPair = {
        player1,
        player2,
        colorIndex: updatedPairs.length % pairColors.length,
        score: (player1.allAround + player2.allAround) / 2
    };
    
    setSubstitutionPairs([...updatedPairs, newPair]);
};

// Function to break a substitution pair
const breakSubstitutionPair = (pairIndex) => {
    const updatedPairs = substitutionPairs.filter((_, index) => index !== pairIndex);
    setSubstitutionPairs(updatedPairs);
};

// Function to reset substitution count
const resetSubstitutionCount = () => {
    setSubstitutionCount(0);
    setCurrentRotation(0);
};

// Enhanced drag and drop for substitutional mode
const handleDropSubstitutional = (e, targetPosition) => {
    e.preventDefault();
    if (!draggedPlayer) return;
    
    if (gameMode === 'substitutional') {
        // Handle substitutional mode drag and drop
        const newPositions = { ...courtPositions };
        
        // Check if this is a valid substitution
        const availablePlayers = getAvailablePlayersForPosition(targetPosition, newPositions, substitutionPairs);
        const isValidSubstitution = availablePlayers.some(p => p.id === draggedPlayer.id);
        
        if (!isValidSubstitution && targetPosition !== 'bench') {
            // Invalid substitution, revert
            setDraggedPlayer(null);
            setDropZone(null);
            return;
        }
        
        // Handle the substitution
        let currentPosition = null;
        Object.keys(newPositions).forEach(pos => {
            if (pos === 'bench') {
                const benchIndex = newPositions[pos].findIndex(p => p.id === draggedPlayer.id);
                if (benchIndex >= 0) {
                    currentPosition = { type: 'bench', index: benchIndex };
                }
            } else if (newPositions[pos] && newPositions[pos].id === draggedPlayer.id) {
                currentPosition = { type: 'court', position: pos };
            }
        });
        
        // Remove from current position
        if (currentPosition) {
            if (currentPosition.type === 'bench') {
                newPositions.bench.splice(currentPosition.index, 1);
            } else {
                newPositions[currentPosition.position] = null;
            }
        }
        
        // Place in new position
        if (targetPosition === 'bench') {
            newPositions.bench.push(draggedPlayer);
        } else {
            // If there's a player in target position, swap them
            if (newPositions[targetPosition]) {
                if (currentPosition && currentPosition.type === 'court') {
                    newPositions[currentPosition.position] = newPositions[targetPosition];
                } else if (currentPosition && currentPosition.type === 'bench') {
                    newPositions.bench.splice(currentPosition.index, 0, newPositions[targetPosition]);
                }
            }
            newPositions[targetPosition] = draggedPlayer;
            
            // Count this as a substitution if moving from bench to court
            if (currentPosition && currentPosition.type === 'bench') {
                setSubstitutionCount(prev => prev + 1);
            }
        }
        
        setCourtPositions(newPositions);
    } else {
        // Use original rotational drag and drop
        handleDrop(e, targetPosition);
    }
    
    setDraggedPlayer(null);
    setDropZone(null);
};
// Updated main return statement with substitutional mode integration

return React.createElement('div', { className: "max-w-md mx-auto bg-white min-h-screen p-4" },
    // PWA Install Prompt
    showInstallPrompt && (
        React.createElement('div', { className: "install-prompt mb-4 p-4 text-white rounded-lg flex items-center justify-between" },
            React.createElement('div', {},
                React.createElement('div', { className: "font-semibold text-sm" }, "Install Volleyball App"),
                React.createElement('div', { className: "text-xs opacity-90" }, "Add to home screen for offline use")
            ),
            React.createElement('div', { className: "flex gap-2" },
                React.createElement('button', {
                    onClick: () => setShowInstallPrompt(false),
                    className: "px-3 py-1 bg-white bg-opacity-20 rounded text-xs"
                }, "Later"),
                React.createElement('button', {
                    onClick: handleInstallClick,
                    className: "px-3 py-1 bg-white text-purple-600 rounded text-xs font-semibold"
                }, "Install")
            )
        )
    ),

    // Header with enhanced save functionality
    React.createElement('div', { className: "flex items-center justify-between mb-6" },
        React.createElement('input', {
            type: "text",
            value: teamName,
            onChange: (e) => setTeamName(e.target.value),
            className: "text-lg font-bold bg-transparent border-b-2 border-gray-300 focus:border-blue-500 outline-none"
        }),
        React.createElement('div', { className: "flex gap-2" },
            React.createElement('button', { 
                onClick: exportData,
                className: "p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600",
                title: "Export team data"
            },
                "ðŸ’¾"
            ),
            React.createElement('label', { 
                className: "p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 cursor-pointer",
                title: "Import team data"
            },
                "ðŸ“‚",
                React.createElement('input', {
                    type: "file",
                    accept: ".json",
                    onChange: handleImportData,
                    className: "hidden"
                })
            )
        )
    ),

    // Game Mode Toggle
    React.createElement(GameModeToggle),

    // Star Player Status (only show in rotational mode)
    gameMode === 'rotational' && React.createElement('div', { className: "mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg" },
        React.createElement('div', { className: "text-sm font-medium text-yellow-800 mb-1" },
            `Star Players: ${players.filter(p => p.star).length}/3`
        ),
        React.createElement('div', { className: "text-xs text-yellow-700" },
            "â­ Select up to 3 star players. Algorithms ensure 1+ star always on court, prefer 2, and prevent adjacent positioning."
        )
    ),

    // Substitution Pairs Display (only show in substitutional mode)
    React.createElement(SubstitutionPairsDisplay),

    // Court Display
    React.createElement('div', { className: "bg-orange-50 border-2 border-orange-300 rounded-lg p-4 mb-6" },
        React.createElement('div', { className: "text-center text-sm font-semibold mb-4 text-orange-800" },
            `${teamName} - Court Layout (${gameMode === 'rotational' ? 'Rotational' : 'Substitutional'} Mode)`
        ),
        
        // Show different info based on mode
        gameMode === 'rotational' && currentStrengths.length > 0 && (
            React.createElement('div', { className: "mb-4 p-3 bg-white rounded-lg border" },
                React.createElement('div', { className: "text-xs font-semibold mb-2 text-center" }, 
                    "Row Totals (Defense) - Min: " + minThreshold
                ),
                React.createElement('div', { className: "flex justify-between text-xs mb-2" },
                    React.createElement('div', {}, 
                        `Front: ${currentStrengths[0]?.frontRowTotal || 0}`,
                        React.createElement('span', { 
                            className: `ml-1 ${(currentStrengths[0]?.frontRowTotal || 0) >= minThreshold ? 'text-green-600' : 'text-red-600'}`
                        }, (currentStrengths[0]?.frontRowTotal || 0) >= minThreshold ? 'âœ“' : 'âœ—')
                    ),
                    React.createElement('div', {}, 
                        `Back: ${currentStrengths[0]?.backRowTotal || 0}`,
                        React.createElement('span', { 
                            className: `ml-1 ${(currentStrengths[0]?.backRowTotal || 0) >= minThreshold ? 'text-green-600' : 'text-red-600'}`
                        }, (currentStrengths[0]?.backRowTotal || 0) >= minThreshold ? 'âœ“' : 'âœ—')
                    )
                ),
                bestLineups.length > 0 && (
                    React.createElement('div', { className: "text-xs text-center text-gray-600" },
                        `Lineup ${currentLineupIndex + 1} of ${bestLineups.length} best options`
                    )
                )
            )
        ),

        gameMode === 'substitutional' && (
            React.createElement('div', { className: "mb-4 p-3 bg-white rounded-lg border" },
                React.createElement('div', { className: "text-xs font-semibold mb-2 text-center" }, 
                    "Substitutional Mode - Optimized for Position Ratings"
                ),
                React.createElement('div', { className: "flex justify-between text-xs mb-2" },
                    React.createElement('div', {}, `Rotation: ${currentRotation + 1}/6`),
                    React.createElement('div', {}, `Substitutions Used: ${substitutionCount}`)
                ),
                React.createElement('div', { className: "text-xs text-center text-gray-600" },
                    "Front row optimized for Setting â€¢ Back row optimized for Serve Receive"
                )
            )
        ),

        // Back Row
        React.createElement('div', { className: "border-b-2 border-dashed border-orange-400 pb-3 mb-3" },
            React.createElement('div', { className: "text-xs text-center mb-2 text-orange-700" }, "Back Row (20 ft)"),
            React.createElement('div', { className: "grid grid-cols-3 gap-2" },
                React.createElement('div', { className: "text-center" },
                    React.createElement('div', { className: "text-xs mb-1" }, "Left (Serve)"),
                    React.createElement('div', {
                        className: `h-16 border-2 border-dashed rounded-lg flex items-center justify-center transition-all ${
                            dropZone === "backLeft" ? 'drop-zone-active' : 'border-gray-300'
                        }`,
                        onDragOver: handleDragOver,
                        onDragEnter: (e) => handleDragEnter(e, "backLeft"),
                        onDragLeave: handleDragLeave,
                        onDrop: (e) => gameMode === 'substitutional' ? handleDropSubstitutional(e, "backLeft") : handleDrop(e, "backLeft")
                    },
                        courtPositions.backLeft ? 
                            React.createElement(PlayerTile, { 
                                player: courtPositions.backLeft, 
                                position: "BL", 
                                isOnCourt: true,
                                onDragStart: handleDragStart
                            }) :
                            React.createElement('span', { className: "text-xs text-gray-400" }, "Empty")
                    )
                ),
                React.createElement('div', { className: "text-center" },
                    React.createElement('div', { className: "text-xs mb-1" }, "Middle"),
                    React.createElement('div', {
                        className: `h-16 border-2 border-dashed rounded-lg flex items-center justify-center transition-all ${
                            dropZone === "backMiddle" ? 'drop-zone-active' : 'border-gray-300'
                        }`,
                        onDragOver: handleDragOver,
                        onDragEnter: (e) => handleDragEnter(e, "backMiddle"),
                        onDragLeave: handleDragLeave,
                        onDrop: (e) => gameMode === 'substitutional' ? handleDropSubstitutional(e, "backMiddle") : handleDrop(e, "backMiddle")
                    },
                        courtPositions.backMiddle ? 
                            React.createElement(PlayerTile, { 
                                player: courtPositions.backMiddle, 
                                position: "BM", 
                                isOnCourt: true,
                                onDragStart: handleDragStart
                            }) :
                            React.createElement('span', { className: "text-xs text-gray-400" }, "Empty")
                    )
                ),
                React.createElement('div', { className: "text-center" },
                    React.createElement('div', { className: "text-xs mb-1" }, "Right"),
                    React.createElement('div', {
                        className: `h-16 border-2 border-dashed rounded-lg flex items-center justify-center transition-all ${
                            dropZone === "backRight" ? 'drop-zone-active' : 'border-gray-300'
                        }`,
                        onDragOver: handleDragOver,
                        onDragEnter: (e) => handleDragEnter(e, "backRight"),
                        onDragLeave: handleDragLeave,
                        onDrop: (e) => gameMode === 'substitutional' ? handleDropSubstitutional(e, "backRight") : handleDrop(e, "backRight")
                    },
                        courtPositions.backRight ? 
                            React.createElement(PlayerTile, { 
                                player: courtPositions.backRight, 
                                position: "BR", 
                                isOnCourt: true,
                                onDragStart: handleDragStart
                            }) :
                            React.createElement('span', { className: "text-xs text-gray-400" }, "Empty")
                    )
                )
            )
        ),

        // Front Row
        React.createElement('div', { className: "border-b-2 border-dashed border-orange-400 pb-3 mb-3" },
            React.createElement('div', { className: "text-xs text-center mb-2 text-orange-700" }, "Front Row (10 ft)"),
            React.createElement('div', { className: "grid grid-cols-3 gap-2" },
                React.createElement('div', { className: "text-center" },
                    React.createElement('div', { className: "text-xs mb-1" }, "Left"),
                    React.createElement('div', {
                        className: `h-16 border-2 border-dashed rounded-lg flex items-center justify-center transition-all ${
                            dropZone === "frontLeft" ? 'drop-zone-active' : 'border-gray-300'
                        }`,
                        onDragOver: handleDragOver,
                        onDragEnter: (e) => handleDragEnter(e, "frontLeft"),
                        onDragLeave: handleDragLeave,
                        onDrop: (e) => gameMode === 'substitutional' ? handleDropSubstitutional(e, "frontLeft") : handleDrop(e, "frontLeft")
                    },
                        courtPositions.frontLeft ? 
                            React.createElement(PlayerTile, { 
                                player: courtPositions.frontLeft, 
                                position: "FL", 
                                isOnCourt: true,
                                onDragStart: handleDragStart
                            }) :
                            React.createElement('span', { className: "text-xs text-gray-400" }, "Empty")
                    )
                ),
                React.createElement('div', { className: "text-center" },
                    React.createElement('div', { className: "text-xs mb-1" }, "Middle"),
                    React.createElement('div', {
                        className: `h-16 border-2 border-dashed rounded-lg flex items-center justify-center transition-all ${
                            dropZone === "frontMiddle" ? 'drop-zone-active' : 'border-gray-300'
                        }`,
                        onDragOver: handleDragOver,
                        onDragEnter: (e) => handleDragEnter(e, "frontMiddle"),
                        onDragLeave: handleDragLeave,
                        onDrop: (e) => gameMode === 'substitutional' ? handleDropSubstitutional(e, "frontMiddle") : handleDrop(e, "frontMiddle")
                    },
                        courtPositions.frontMiddle ? 
                            React.createElement(PlayerTile, { 
                                player: courtPositions.frontMiddle, 
                                position: "FM", 
                                isOnCourt: true,
                                onDragStart: handleDragStart
                            }) :
                            React.createElement('span', { className: "text-xs text-gray-400" }, "Empty")
                    )
                ),
                React.createElement('div', { className: "text-center" },
                    React.createElement('div', { className: "text-xs mb-1" }, "Right"),
                    React.createElement('div', {
                        className: `h-16 border-2 border-dashed rounded-lg flex items-center justify-center transition-all ${
                            dropZone === "frontRight" ? 'drop-zone-active' : 'border-gray-300'
                        }`,
                        onDragOver: handleDragOver,
                        onDragEnter: (e) => handleDragEnter(e, "frontRight"),
                        onDragLeave: handleDragLeave,
                        onDrop: (e) => gameMode === 'substitutional' ? handleDropSubstitutional(e, "frontRight") : handleDrop(e, "frontRight")
                    },
                        courtPositions.frontRight ? 
                            React.createElement(PlayerTile, { 
                                player: courtPositions.frontRight, 
                                position: "FR", 
                                isOnCourt: true,
                                onDragStart: handleDragStart
                            }) :
                            React.createElement('span', { className: "text-xs text-gray-400" }, "Empty")
                    )
                )
            )
        ),

        // Net
        React.createElement('div', { className: "w-full h-2 bg-black mb-4 rounded" }),

        // Rotation Controls
        React.createElement('div', { className: "flex justify-center gap-4 mb-4" },
            React.createElement('button', {
                onClick: gameMode === 'substitutional' ? rotateBackwardSubstitutional : rotateBackward,
                className: "flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed",
                disabled: [courtPositions.backLeft, courtPositions.backMiddle, courtPositions.backRight, courtPositions.frontLeft, courtPositions.frontMiddle, courtPositions.frontRight].filter(Boolean).length < 6
            },
                "âŸ² Previous"
            ),
            React.createElement('button', {
                onClick: gameMode === 'substitutional' ? rotateForwardSubstitutional : rotateForward,
                className: "flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed",
                disabled: [courtPositions.backLeft, courtPositions.backMiddle, courtPositions.backRight, courtPositions.frontLeft, courtPositions.frontMiddle, courtPositions.frontRight].filter(Boolean).length < 6
            },
                "Next âŸ³"
            ),
            gameMode === 'substitutional' && React.createElement('button', {
                onClick: resetSubstitutionCount,
                className: "px-3 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 text-sm",
                title: "Reset substitution count"
            }, "Reset")
        )
    ),
// Bench Display
    React.createElement('div', { 
        className: "bg-green-50 border-2 border-green-300 rounded-lg p-4 mb-6",
        onDragOver: handleDragOver,
        onDragEnter: (e) => handleDragEnter(e, 'bench'),
        onDragLeave: handleDragLeave,
        onDrop: (e) => gameMode === 'substitutional' ? handleDropSubstitutional(e, 'bench') : handleDrop(e, 'bench')
    },
        React.createElement('div', { className: "text-center text-sm font-semibold mb-3 text-green-800" },
            gameMode === 'rotational' ? "Bench Players (Next to rotate in at bottom)" : "Available Substitutes"
        ),
        React.createElement('div', { className: "space-y-2" },
            courtPositions.bench.map((player, index) => (
                React.createElement('div', { key: player.id, className: "flex items-center gap-2" },
                    gameMode === 'rotational' && React.createElement('span', { className: "text-xs w-6 text-center" }, index + 1),
                    React.createElement(PlayerTile, { 
                        player: player, 
                        isOnCourt: false, 
                        benchIndex: index,
                        onDragStart: handleDragStart
                    })
                )
            )),
            courtPositions.bench.length === 0 && (
                React.createElement('div', { className: "text-center text-gray-500 text-sm" }, "No bench players")
            )
        )
    ),

    // Optimization Controls (different for each mode)
    gameMode === 'rotational' ? (
        React.createElement('div', { className: "mb-4 p-4 bg-gray-50 rounded-lg" },
            React.createElement('div', { className: "mb-3" },
                React.createElement('label', { className: "block text-sm font-medium mb-1" }, 
                    `Minimum Row Total: ${minThreshold}`
                ),
                React.createElement('input', {
                    type: "range",
                    min: "3",
                    max: "15",
                    value: minThreshold,
                    onChange: (e) => setMinThreshold(parseInt(e.target.value)),
                    className: "w-full"
                }),
                React.createElement('div', { className: "flex justify-between text-xs text-gray-500 mt-1" },
                    React.createElement('span', {}, "3"),
                    React.createElement('span', {}, "15")
                )
            ),
            React.createElement('div', { className: "flex gap-2" },
                React.createElement('button', {
                    onClick: optimizeStandardPlay,
                    className: `flex-1 p-3 text-white rounded-lg transition-colors ${
                        isOptimizing ? 'optimizing cursor-not-allowed' : 'bg-purple-500 hover:bg-purple-600'
                    }`,
                    disabled: isOptimizing || players.filter(p => p.active).length < 6
                },
                    isOptimizing ? "Optimizing..." : "ðŸŽ¯ Standard Play"
                ),
                React.createElement('button', {
                    onClick: optimizeServingPriority,
                    className: `flex-1 p-3 text-white rounded-lg transition-colors ${
                        isOptimizing ? 'optimizing cursor-not-allowed' : 'bg-orange-500 hover:bg-orange-600'
                    }`,
                    disabled: isOptimizing || players.filter(p => p.active).length < 6
                },
                    isOptimizing ? "Optimizing..." : "âš¡ Serving Priority"
                ),
                React.createElement('button', {
                    onClick: shuffleStandardPlay,
                    className: "px-3 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:bg-gray-400",
                    disabled: bestLineups.length === 0,
                    title: "Shuffle through best lineups"
                },
                    "ðŸ”€"
                )
            ),
            React.createElement('div', { className: "flex gap-2 mt-2" },
                React.createElement('button', {
                    onClick: autoArrangePlayers,
                    className: "flex-1 p-3 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors",
                    disabled: players.filter(p => p.active).length < 6
                },
                    "ðŸ“‹ Basic Setup"
                )
            )
        )
    ) : (
        React.createElement('div', { className: "mb-4 p-4 bg-gray-50 rounded-lg" },
            React.createElement('div', { className: "text-sm font-medium mb-3" }, "Substitutional Controls"),
            React.createElement('div', { className: "flex gap-2 mb-3" },
                React.createElement('button', {
                    onClick: optimizeSubstitutionPairs,
                    className: "flex-1 p-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors",
                    disabled: players.filter(p => p.active).length < 6
                },
                    "ðŸ”„ Optimize Pairs"
                ),
                React.createElement('button', {
                    onClick: () => {
                        setSubstitutionPairs([]);
                        setSubstitutionCount(0);
                        setPlayers(prev => prev.map(p => ({ ...p, noSub: false })));
                    },
                    className: "px-4 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
                },
                    "Clear Pairs"
                )
            ),
            React.createElement('div', { className: "text-xs text-gray-600" },
                "Tip: Drag players to manually adjust court positions. Only valid substitutions are allowed."
            )
        )
    ),

    // Players List
    React.createElement('div', { className: "mb-6" },
        React.createElement('div', { className: "flex items-center justify-between mb-3" },
            React.createElement('h2', { className: "text-lg font-semibold" }, `Team Roster (${players.length}/12)`),
            React.createElement('button', {
                onClick: () => setShowPlayerForm(true),
                className: "flex items-center gap-2 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors"
            },
                "+ Add Player"
            )
        ),
        
        React.createElement('div', { className: "space-y-2" },
            players.map(player => {
                const pairColor = getPlayerPairColor(player.id);
                return React.createElement('div', { 
                    key: player.id, 
                    className: `flex items-center gap-3 p-2 rounded-lg ${pairColor?.bg || 'bg-white'} ${pairColor?.border ? `border ${pairColor.border}` : 'border border-gray-200'}`
                },
                    React.createElement('button', {
                        onClick: () => togglePlayerActive(player.id),
                        className: `w-4 h-4 rounded border-2 ${
                            player.active ? 'bg-green-500 border-green-500' : 'border-gray-300'
                        }`
                    }),
                    gameMode === 'rotational' && React.createElement('button', {
                        onClick: () => togglePlayerStar(player.id),
                        className: `w-6 h-6 rounded-full border-2 flex items-center justify-center ${
                            player.star ? 'bg-yellow-400 border-yellow-500' : 'border-gray-300 hover:border-yellow-400'
                        } ${players.filter(p => p.star).length >= 3 && !player.star ? 'opacity-50 cursor-not-allowed' : ''}`,
                        disabled: players.filter(p => p.star).length >= 3 && !player.star
                    },
                        React.createElement('span', { className: "text-xs" }, player.star ? 'â­' : 'â˜†')
                    ),
                    React.createElement('div', { className: "flex-1" },
                        React.createElement('div', { className: "flex items-center gap-2" },
                            React.createElement('span', { className: "font-semibold" }, player.name),
                            gameMode === 'substitutional' && player.noSub && React.createElement('span', { className: "text-xs bg-yellow-200 px-1 rounded" }, "No Sub"),
                            gameMode === 'substitutional' && pairColor && pairColor.name !== 'unpaired' && pairColor.name !== 'gold' && (
                                React.createElement('span', { className: "text-xs px-1 rounded", style: { backgroundColor: pairColor.bg } }, 
                                    `Pair: ${pairColor.name}`
                                )
                            )
                        ),
                        React.createElement('div', { className: "text-xs text-gray-600" },
                            gameMode === 'rotational' 
                                ? `D:${player.defense} S:${player.serving}`
                                : `D:${player.defense} S:${player.serving} SR:${player.serveReceive} Set:${player.setting} AA:${player.allAround}`
                        )
                    ),
                    React.createElement('button', {
                        onClick: () => handleEditPlayer(player),
                        className: "px-2 py-1 text-xs bg-blue-100 text-blue-600 rounded hover:bg-blue-200"
                    }, "Edit")
                );
            })
        )
    ),

    // Enhanced Player Form Modal
    React.createElement(EnhancedPlayerForm)
);

// Close the main component
};

// Render the app
ReactDOM.render(React.createElement(VolleyballApp), document.getElementById('root'));
    </script>
</body>
                    </html>
